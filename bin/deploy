#!/usr/bin/env ruby

APP_ROOT = "#{File.dirname(File.expand_path(__FILE__))}/.."

$: << "#{APP_ROOT}/lib"

require 'optparse'

options = {}
op = OptionParser.new do |opts|
  opts.banner = "Usage: example.rb [options]"
  opts.on("-r", "--recipe RECIPE", "The recipe file")             { |r| options[:recipe] = r      }
  opts.on("-e", "--environment ENV", "Environment to execute in") { |e| options[:environment] = e }
  opts.on("-m", "--method METHOD", "The method to run")           { |m| options[:method] = m      }
  opts.on("-c", "--config CONFIG", "Path to custome config")      { |c| options[:config] = c      }
end

op.parse!

[:recipe, :environment, :method].each do |param|
  unless options.keys.include?(param)
    puts op.summarize
    exit(1)
  end
end

recipe = options[:recipe]
env    = options[:environment]
method = options[:method]
config_file = options[:config]

require "deploy/config"
require "deploy/base"
require "deploy/remote_commands"
require "deploy/recipies/#{recipe}"

c = ::Deploy::Config.new

puts "THIS FILE IS #{File.expand_path(File.new(".").path)}"

c.set :env, env
c.config_environment
c.config_custom(config_file) if config_file

r = eval("::Deploy::Recipies::#{recipe[0,1].upcase}#{recipe[1,recipe.size - 1]}")

r.send(method.to_sym, c)

r.push!

